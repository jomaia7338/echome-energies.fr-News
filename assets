// assets/tarifs.js
// Dynamically load tariffs from /data/tarifs.json and render into a table.
// Usage in HTML: <script defer src="/assets/tarifs.js"></script>

(function(){
  async function loadTarifs() {
    try{
      const res = await fetch('/data/tarifs.json', {cache: 'no-store'});
      const data = await res.json();
      const target = document.querySelector('#tarifs-table-body');
      const caption = document.querySelector('#tarifs-caption');
      const meta = document.querySelector('#tarifs-meta');
      if(!target) return;

      target.innerHTML = '';
      for (const row of data.edf_oa_surplus){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <th scope="row">${row.range} (${row.segment})</th>
          <td><strong>${row.eur_per_kwh.toFixed(4).replace('.', ',')}</strong></td>
          <td>Surplus ${row.example_surplus_kwh.toLocaleString('fr-FR')} kWh â†’ <strong>${(row.example_surplus_kwh * row.eur_per_kwh).toLocaleString('fr-FR', {style:'currency', currency:'EUR'})}</strong>/an</td>
        `;
        target.appendChild(tr);
      }
      if(caption){
        caption.textContent = `Tarifs de rachat (EDF OA) â€” Surplus (${data.version})`;
      }
      if(meta){
        meta.textContent = `DonnÃ©es mises Ã  jour automatiquement â€” ${new Date(data.last_updated).toLocaleDateString('fr-FR')}`;
      }

      // KPI autoconsommation value
      const kpi = document.querySelector('#kpi-autoconso-value');
      if(kpi){
        kpi.innerHTML = `ðŸ’¡ Un kWh autoconsommÃ© vaut ~<strong>${data.avg_autoconsommation_value_ttc_eur_per_kwh.toFixed(2).replace('.', ',')} â‚¬/kWh TTC</strong>`;
      }
    }catch(e){
      console.error('Erreur chargement tarifs:', e);
    }
  }
  document.addEventListener('DOMContentLoaded', loadTarifs);
})();
